{ config, pkgs, lib, ... }:

pkgs.linuxPackagesFor (pkgs.linux_5_14_hardened.override {
  structuredExtraConfig = with lib.kernel; {
    ACPI_TABLE_UPGRADE = no;
    AIO = lib.mkForce no;
    BINFMT_MISC = yes; # NOTE
    BPF_SYSCALL = lib.mkForce no;
    BUG_ON_DATA_CORRUPTION = yes;
    COMPAT_BRK = no;
    COMPAT_VDSO = no;
    COREDUMP = no;
    CRASH_DUMP = no;
    CRYPTO_JITTERENTROPY = yes;
    DEBUG_FS = no;
    DEBUG_WX = yes;
    DEBUG_VIRTUAL = yes;
    DEVMEM = no;
    DEVPORT = no;
    FORTIFY_SOURCE = yes;
    HARDENED_USERCOPY = yes;
    HARDENED_USERCOPY_FALLBACK = no;
    HARDENED_USERCOPY_PAGESPAN = no;
    HIBERNATION = no;
    INET_DIAG = yes; # NOTE
    INIT_ON_ALLOC_DEFAULT_ON = yes;
    INIT_ON_FREE_DEFAULT_ON = yes;
    KEXEC = no;
    KSM = lib.mkForce no;
    LDISC_AUTOLOAD = no;
    MAGIC_SYSRQ_DEFAULT_ENABLE = freeform "0x84";
    PROC_PAGE_MONITOR = no;
    PAGE_POISONING = no;
    PAGE_SANITIZE = yes;
    PAGE_SANITIZE_VERIFY = yes;
    PROFILING = no;
    RANDOM_TRUST_CPU = lib.mkForce no;
    RANDOM_TRUST_BOOTLOADER = no;
    RESET_ATTACK_MITIGATION = yes;
    SECURITY_LOCKDOWN_LSM = no; # NOTE: depends on sigs
    SLAB_FREELIST_HARDENED = yes;
    SLAB_FREELIST_RANDOM = yes;
    SLAB_MERGE_DEFAULT = no;
    STACKPROTECTOR = yes;
    STACKPROTECTOR_STRONG = yes;
    STAGING = lib.mkForce no;
    SYN_COOKIES = yes;
    SYSFS_SYSCALL = no;
    USELIB = no;
    VMAP_STACK = yes;
    KEYS = yes;
    KEY_DH_OPERATIONS = yes;
    SECURITY_DMESG_RESTRICT = yes;
    SECURITY_PERF_EVENTS_RESTRICT = yes;
    SECURITY_TIOCSTI_RESTIRCT = yes;
    SECURITY_NETWORK_XFRM = yes;
    SECURITY_PATH = yes;

    # NOTE: generate our own key for r13y
    #MODULE_SIG = no;
    #MODULE_SIG_FORCE = no;
    #MODULE_SIG_ALL = yes;
    #MODULE_SIG_SHA512 = yes;
    #MODULE_SIG_KEY = freeform "certs/signing_key.pem";

    HW_RANDOM = yes;
    HW_RANDOM_AMD = yes;
    HW_RANDOM_INTEL = yes;
    ATA = yes;
    SATA_AHCI = yes;
    AMD_IOMMU_v2 = yes;
    ANDROID = no;
    ATA_SFF = no;
    B43 = no;
    B43LEGACY = no;
    B44 = no;
    BE2ISCSI = no;
    BLK_DEV_3W_XXXX_RAID = no;
    BLK_DEV_BSG = yes;
    BLK_DEV_SD = yes;
    BLK_DEV_SR = yes;
    CHR_DEV_SCH = no;
    CHR_DEV_SG = no;
    CHR_DEV_ST = no;
    CNIC = no;
    CONFIGFS_FS = yes;
    CYPRESS_FIRMWARE = no;
    DRM_I810 = no;
    DRM_I830 = no;
    DRM_MGA = no;
    DRM_NOUVEAU = no;
    DRM_R128 = no;
    DRM_RADEON = no;
    DRM_SAVAGE = no;
    DRM_SIS = no;
    DRM_TDFX = no;
    DRM_VIA = no;
    DVB_CORE = no;
    FIREWIRE = no;
    FPGA = no;
    HW_RANDOM_TPM = yes;
    I2C_GPIO = no;
    IIO = no;
    INFINIBAND = no;
    INTEL_IOMMU_DEFAULT_ON = yes;
    INTEL_IOMMU_SVM = no;
    INTEL_TH = no;
    INTEL_TXT = no;
    ISCSI_BOOT_SYSFS = no;
    ISCSI_TCP = no;
    LEGACY_PTYS = no;
    MEDIA_ANALOG_TV_SUPPORT = lib.mkForce no;
    MEDIA_CAMERA_SUPPORT = yes;
    MEDIA_DIGITAL_DV_SUPPORT = no;
    MEDIA_USB_SUPPORT = yes;
    NOUVEAU_LEGACY_CTX_SUPPORT = no;
    PDC_ADMA = no;
    RAPIDIO = no;
    RC_CORE = no;
    SCSI = yes;
    SCSI_3W_9XXX = no;
    SCSI_BNX2X_FCOE = no;
    SCSI_BNX2_ISCSI = no;
    SCSI_CONSTANTS = yes;
    SCSI_CXGB4_ISCSI = no;
    SCSI_DMA = no;
    SCSI_ENCLOSURE = no;
    SCSI_ESP_PIO = no;
    SCSI_FC_ATTRS = no;
    SCSI_GXGB3_ISCSI = no;
    SCSI_HPSA = no;
    SCSI_ISCSI_ATTRS = no;
    SCSI_LOGGING = yes;
    SCSI_NETLINK = no;
    SCSI_PROC_FS = no;
    SCSI_SAS_ATTRS = no;
    SCSI_SCAN_ASYNC = yes;
    SCSI_SPI_ATTRS = no;
    SCSI_SRP_ATTRS = no;
    SGIWD92_SCSI = no;
    SIOX = no;
    SLIMBUS = no;
    SND_JACK = no;
    SND_OSSEMUL = lib.mkForce no;
    SOUNDWIRE = no;
    SOUND_OSS_CORE = no;
    SPMI = no;
    SSB = no;
    STM = no;
    TARGET_CORE = no;
    TCG_TPM = yes;
    THUNDERBOLT = no;
    TTPCI_EEPROM = no;
    UIO = no;
    UNISYS_VISORBUS = no;
    VIDEO_CX2341X = no;
    VIDEO_TVEEPROM = no;
    VIDEO_VIVID = no;
    VME_BUS = no;
    W1 = no;
    W1_CON = no;
    XILLYBUS = no;
    XILLYUSB = no;
    SCSI_3W_SAS = no;
    SCSI_ACARD = no;
    SCSI_AHA152X = no;
    SCSI_AHA1542 = no;
    SCSI_AHA1740 = no;
    SCSI_AACRAID = no;
    SCSI_MVUMI = no;
    SCSI_DPT_I20 = no;
    SCSI_ADVANSYS = no;
    SCSI_ARCMSR = no;
    SCSI_HPTIOP = no;
    SCSI_BUSLOGIC = no;
    SCSI_FLASHPOINT = no;
    SCSI_MYRB = no;
    SCSI_MYRS = no;
    VMWARE_PVSCSI = no;
    XEN_SCSI_FRONTEND = no;
    HYPERV_STORAGE = no;
    LIBFC = no;
    LIBFCOE = no;
    SCSI_AIC7XXX = no;
    SCSI_AIC79XX = no;
    SCSI_DMX3191D = no;
    SCSI_SYM53C8XX_2 = no;
    SCSI_DC395x = no;
    SCSI_AM53C974 = no;
    PCMCIA = no;
    FUSION = lib.mkForce no;
    SCSI_QLA_ISCSI = no;
    SCSI_SAS_LIBSAS = no;
    SCSI_MPT2SAS = no;
    SCSI_MPT3SAS = no;
    SCSI_SMARTPQI = no;
    SCSI_CXGB3_ISCSI = no;
    SCSI_AIC94XX = no;
    SCSI_MVSAS = no;
    SCSI_ISCI = no;
    SCSI_PM8001 = no;
    ISCSI_IBFT = no;
    BATTERY_DS2780 = no;
    BATTERY_DS2781 = no;
    SCSI_SNIC = no;
    FDOMAIN_PCI = no;
    FDOMAIN_ISA = no;
    SCSI_GENERIC_NCR5380 = no;
    SCSI_IPS = no;
    SCSI_INITIO = no;
    SCSI_INIA100 = no;
    PARPORT_PC = no;
    SCSI_STEX = no;
    SCSI_IPR = no;
    ISA_BUS = no;
    SCSI_QLOGIC_1280 = no;
    SCSI_LPFC = no;
    EISA = no;
    
    DEFAULT_MMAP_MIN_ADDR = freeform "65536";
    IA32_EMULATION = no;
    LEGACY_VSYSCALL_NONE = yes;
    MODIFY_LDT_SYSCALL = no;
    PAGE_TABLE_ISOLATION = yes;
    RANDOMIZE_BASE = yes;
    RANDOMIZE_KSTACK_OFFSET_DEFAULT = yes;
    RANDOMIZE_MEMORY = yes;
    X86_64 = yes;
    X86_MSR = no;
    X86_VSYSCALL_EMULATION = no;
    X86_X32 = no; # NOTE
  };

  ignoreConfigErrors = true;
})
